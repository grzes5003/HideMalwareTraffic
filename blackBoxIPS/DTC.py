from sklearn.model_selection import train_test_split
from util.data_constants import MIXED_CSV_PATH, GEN
from blackBoxIPS.BlackBoxBase import BlackBoxBase
from sklearn.tree import DecisionTreeClassifier
from typing import Tuple
import pandas as pd
import numpy as np
import pickle
import os


class DTClassifier(BlackBoxBase):
    def __init__(self):
        self.model = DTClassifier.load_model()

    def rate_flow(self, flow: np.ndarray) -> Tuple[bool, int]:
        return self.model.predict(flow)

    @staticmethod
    def load_model():
        PATH = os.path.dirname(__file__)
        with open(os.path.join(PATH, f'..\\saved_models\\{GEN}\\model_dtc.pkl'), 'rb') as file:
            model = pickle.load(file)
        return model

    @staticmethod
    def train_model():
        PATH = os.path.dirname(__file__)
        dtc = DecisionTreeClassifier(random_state=42)

        # df_normal = pd.read_csv('saved_data/df_normal.csv')
        df_all = pd.read_csv(MIXED_CSV_PATH)
        # df_all.drop('Unnamed: 0', axis=1, inplace=True)

        x_labels = df_all['class'].values
        df_all = df_all.drop('class', axis=1)

        x_all = df_all.values

        x_train_all, _, x_train_label, _ = train_test_split(
            x_all, x_labels, test_size=0.25, random_state=42)

        dtc.fit(x_train_all, x_train_label)

        with open(os.path.join(PATH, f'..\\saved_models\\{GEN}\\model_dtc.pkl'), 'wb') as file:
            pickle.dump(dtc, file)

        print('done')


if __name__ == '__main__':
    DTClassifier.train_model()