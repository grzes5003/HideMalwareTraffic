import os

import pandas as pd
from preprocessors import encode_numeric_zscore
from util.data_constants import col_binary_dict, GEN2, GEN


def bin2int(arr: [int]):
    res = 0
    for bit in arr:
        res = (res << 1) | bit
    return res


def decode_text_binary(df, name, bits: int):
    res = list(zip(*[df[f"{name}_{idx}"] for idx in range(bits)]))
    int_res = [bin2int(val) for val in res]

    [df.drop(f"{name}_{idx}", axis=1, inplace=True) for idx in range(bits)]
    df[name] = int_res


def retrieve_generated_data(path):
    df = pd.read_csv(path)

    for name, bits in col_binary_dict.items():
        decode_text_binary(df, name, bits)

    cols = ['Proto', 'Sport', 'Dport']
    for col in cols:
        df[col] = df.filter(regex=f"{col}-*").idxmax(1)
        [df.drop(name, axis=1, inplace=True) for name in df.filter(regex=f"{col}-").columns]

    print('done')
    return df


def retrieve_generated_data_gen2(path):
    df = pd.read_csv(path)

    for name, bits in GEN2.col_binary_dict.items():
        decode_text_binary(df, name, bits)

    for col in GEN2.col_dummy_decode:
        df[col] = df.filter(regex=f"{col}-*").idxmax(1)
        [df.drop(name, axis=1, inplace=True) for name in df.filter(regex=f"{col}-").columns]

    print('done')
    return df


def prep_data_as_cont(df, path):
    cont_tags_map = list(
        map(lambda _name: (_name, df[_name].mean(), df[_name].std()), ['dTos', 'sTos', 'SrcPkts', 'DstPkts']))
    [encode_numeric_zscore(df, name, _min, _max) for (name, _min, _max) in cont_tags_map]

    [df.drop(val, axis=1, inplace=True) for val in ['Sport', 'Dport', 'Proto', 'weekday']]

    df.to_csv(os.path.join(os.path.dirname(path),
                           f'{os.path.splitext(os.path.basename(path))[0]}_cont_prepared.csv'),
              index=False)
    print('Done')


def prep_data_as_cont_gen2(df, path):
    cont_tags_map = list(
        map(lambda _name: (_name, df[_name].min(), df[_name].max()), GEN2.col_binary_dict.keys()))
    [encode_numeric_zscore(df, name, _min, _max) for (name, _min, _max) in cont_tags_map]

    [df.drop(val, axis=1, inplace=True) for val in ['Sport', 'Dport', 'Proto']]

    df.to_csv(os.path.join(os.path.dirname(path),
                           f'{os.path.splitext(os.path.basename(path))[0]}_cont_prepared.csv'),
              index=False)
    print('Done')


def prep_data_add_labels_gen2(path):
    df = pd.read_csv(path)

    cols = ['Dur', 'daytime', 'sTos', 'dTos', 'SrcBytes', 'DstBytes', 'SrcLoad', 'DstLoad', 'SrcRate', 'DstRate',
            'SrcPkts', 'DstPkts']
    df.columns = cols

    df.to_csv(os.path.join(os.path.dirname(path),
                           f'{os.path.splitext(os.path.basename(path))[0]}_cont_prepared.csv'),
              index=False)
    print('Done')


if __name__ == '__main__':
    path = f'..\\saved_data\\wgan_{GEN}_data_generated_2_desc.csv'
    df = retrieve_generated_data_gen2(path)
    prep_data_as_cont_gen2(df, path)

    # prep_data_add_labels_gen2(path)
